language: rust
sudo: false

cache: cargo
dist: trusty
os:
  - linux

#run builds for Rust nightly, Beta and stable
rust:
  - nightly
  - beta
  - stable

matrix:
  allow_failures:
    - rust: nightly

env:
  global:
    - RUSTFLAGS="-C link-dead-code"

#For codecov
addons:
  apt:
    packages:
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev
      - cmake
      - gcc
      - binutils-dev
      - libiberty-dev


# The main build
script:
  - cargo build --verbose
  - cargo test --verbose

#Code to run after build success
#Used by codecov
after_success:
   # Coverage report
     - |
         if [[ "$TRAVIS_OS_NAME" == "linux" && "$TRAVIS_RUST_VERSION" == "stable" ]]; then
           wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &&
           tar xzf master.tar.gz &&
           cd kcov-master &&
           mkdir build &&
           cd build &&
           cmake .. &&
           make &&
           sudo make install &&
           cd ../.. &&
           rm -rf kcov-master &&
           for file in target/debug/blacksmith-*[^\.d]; do mkdir -p "target/cov/$(basename $file)"; kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file"; done &&
           bash <(curl -s https://codecov.io/bash) &&
           echo "Uploaded code coverage"
         fi